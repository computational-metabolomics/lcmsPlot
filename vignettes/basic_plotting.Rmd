---
title: "Basic plotting with lcmsPlot"
output:
  BiocStyle::html_document:
    toc: true
    toc_depth: 2  
    number_sections: true  
    toc_float: true
vignette: >
  %\VignetteIndexEntry{basic_plotting}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_knit$set(
  root.dir = dirname(getwd())
)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

suppressPackageStartupMessages({
  library(dplyr)
  library(ggplot2)
  library(openxlsx)
  library(xcms)
  library(BiocStyle)
  library(lcmsPlot)
})
```

# Load data

```{r}
xdata <- readRDS(system.file("extdata", "xdata.rds", package = "lcmsPlot"))
```

# Samples summary

## Plot base peak chromatogram (BPC)

```{r}
raw_files <- c(
  "inst/extdata/data/Human_Plasma_HILP_Ch1_Col1_scIC_062.mzML",
  "inst/extdata/data/Human_Plasma_HILP_Ch1_Col1_scIC_064.mzML"
)

lcmsPlot(raw_files) +
  chromatogram(ppm = 5, rt_tol = 10, aggregation_fun = "max") +
  facets(facets = "sample_id", ncol = 1)
```

## Plot base peak chromatogram (BPC) overlapped

```{r}
raw_files <- c(
  "inst/extdata/data/Human_Plasma_HILP_Ch1_Col1_scIC_062.mzML",
  "inst/extdata/data/Human_Plasma_HILP_Ch1_Col1_scIC_064.mzML"
)

lcmsPlot(raw_files) +
  chromatogram(ppm = 5, rt_tol = 10, aggregation_fun = "max") +
  arrange(group_by = "sample_id") +
  labels(title = "Base peak chromatograms", legend = "Sample") +
  legend(position = "bottom")
```

## Plot total ion chromatogram (TIC)

```{r}
raw_files <- c(
  "inst/extdata/data/Human_Plasma_HILP_Ch1_Col1_scIC_062.mzML",
  "inst/extdata/data/Human_Plasma_HILP_Ch1_Col1_scIC_064.mzML"
)

lcmsPlot(raw_files) +
  chromatogram(ppm = 5, rt_tol = 10, aggregation_fun = "sum") +
  facets(facets = "sample_id", ncol = 1)
```

## Intensity maps

```{r}
raw_files <- c(
  "inst/extdata/data/Human_Plasma_HILP_Ch1_Col1_scIC_062.mzML",
  "inst/extdata/data/Human_Plasma_HILP_Ch1_Col1_scIC_064.mzML"
)

lcmsPlot(raw_files) +
  intensity_map(mz_range = c(100, 105), rt_range = c(0, 200), density = TRUE) +
  facets(facets = "sample_id", ncol = 2)
```

# Plot chromatograms in the same panel

```{r}
lcmsPlot(xdata, 'sample_id') +
  chromatogram(features = 'M70T581',
                       sample_ids = c(
                         'Human_Plasma_HILP_Ch1_Col1_scIC_062',
                         'Human_Plasma_HILP_Ch1_Col1_scIC_064'),
                       ppm = 5,
                       rt_tol = 10,
                       highlight_peaks = TRUE) +
  arrange(group_by = 'sample_id') +
  labels(title = "Feature M70T581", legend = "Sample") +
  legend(position = "bottom")
```

# Plot chromatograms in the same panel with mass trace

```{r}
lcmsPlot(xdata, 'sample_id') +
  chromatogram(features = 'M70T581',
                       sample_ids = c(
                         'Human_Plasma_HILP_Ch1_Col1_scIC_062',
                         'Human_Plasma_HILP_Ch1_Col1_scIC_064'),
                       ppm = 5,
                       rt_tol = 10,
                       highlight_peaks = TRUE) +
  mass_trace() +
  arrange(group_by = 'sample_id') +
  labels(title = "Feature M70T581", legend = "Sample") +
  legend(position = "bottom")
```

# Plot faceted chromatograms

```{r}
lcmsPlot(xdata, 'sample_id') +
  chromatogram(features = c('M70T581', 'M85T587_1'),
               sample_ids = c('Human_Plasma_HILP_Ch1_Col1_scIC_062',
                              'Human_Plasma_HILP_Ch1_Col1_scIC_064'),
               ppm = 5,
               rt_tol = 10,
               highlight_peaks = TRUE,
               highlight_peaks_color = "#121212") +
  facets(facets = c('feature_id', 'sample_id')) +
  labels(legend = "Sample") +
  legend(position = "bottom")
```

# Plot faceted chromatograms with RT lines

```{r}
lcmsPlot(xdata, 'sample_id') +
  chromatogram(features = 'M70T581',
                       sample_ids = c(
                         'Human_Plasma_HILP_Ch1_Col1_scIC_062',
                         'Human_Plasma_HILP_Ch1_Col1_scIC_064'),
                       ppm = 5,
                       rt_tol = 10) +
  facets(facets = 'sample_id') +
  rt_line(intercept = 580, line_type = 'solid', color = 'red') +
  rt_line(intercept = 575, line_type = 'dashed', color = 'blue') +
  rt_line(intercept = 587, line_type = 'dashed', color = 'blue')
```

# Plot faceted chromatograms with mass traces (1)

```{r}
lcmsPlot(xdata, 'sample_id') +
  chromatogram(features = c('M70T581', 'M85T587_1'),
               sample_ids = c(
                 'Human_Plasma_HILP_Ch1_Col1_scIC_062',
                 'Human_Plasma_HILP_Ch1_Col1_scIC_064'),
               ppm = 5,
               rt_tol = 10,
               highlight_peaks = TRUE,
               highlight_peaks_color = '#343434') +
  mass_trace() +
  facets(facets = c('feature_id', 'sample_id'))
```

# Plot faceted chromatograms with mass traces (2) 

```{r}
lcmsPlot(xdata, 'sample_id') +
  chromatogram(features = c('M70T581', 'M85T587_1'),
                       sample_ids = c(
                         'Human_Plasma_HILP_Ch1_Col1_scIC_062',
                         'Human_Plasma_HILP_Ch1_Col1_scIC_064'),
                       ppm = 5,
                       rt_tol = 10,
                       highlight_peaks = TRUE) +
  mass_trace() +
  arrange(group_by = "sample_id") +
  facets(facets = 'feature_id', ncol = 2) +
  labels(legend = "Sample") +
  legend(position = "bottom")
```

# Plot chromatograms in grid layout

```{r}
lcmsPlot(xdata, 'sample_id') +
  chromatogram(features = c('M70T581', 'M85T587_1'),
               sample_ids = c(
                 'Human_Plasma_HILP_Ch1_Col1_scIC_062',
                 'Human_Plasma_HILP_Ch1_Col1_scIC_064'),
               ppm = 5,
               rt_tol = 10,
               highlight_peaks = TRUE,
               highlight_peaks_color = '#f00') +
  grid(rows = 'feature_id', cols = 'sample_id')
```

# Plot chromatograms in grid layout with mass traces

TODO

# Plot chromatograms from raw files

```{r}
raw_files <- c(
  "inst/extdata/data/Human_Plasma_HILP_Ch1_Col1_scIC_062.mzML",
  "inst/extdata/data/Human_Plasma_HILP_Ch1_Col1_scIC_064.mzML"
)

lcmsPlot(raw_files) +
  chromatogram(features = rbind(c(mz = 70.06507, rt = 580.642449), c(mz = 85.06472, rt = 587.131287)),
               ppm = 5,
               rt_tol = 10) +
  arrange(group_by = "sample_id") +
  facets(facets = "feature_id", ncol = 2) +
  legend(position = "bottom") +
  labels(legend = "Sample")
```

# Plot chromatograms from raw files and metadata

```{r}
raw_files <- c(
  "inst/extdata/data/Human_Plasma_HILP_Ch1_Col1_scIC_062.mzML",
  "inst/extdata/data/Human_Plasma_HILP_Ch1_Col1_scIC_064.mzML"
)

metadata <- data.frame(
  sample_type = c("T1", "T2"),
  sample_id = c("S62", "S64")
)

lcmsPlot(raw_files, sample_id_column = "sample_id", metadata = metadata) +
  chromatogram(features = rbind(c(mz = 70.06507, rt = 580.642449), c(mz = 85.06472, rt = 587.131287)),
               ppm = 5,
               rt_tol = 10) +
  grid(rows = 'feature_id', cols = 'sample_type')
```

# Plot chromatograms with spectra

```{r}
lcmsPlot(xdata, 'sample_id') +
  chromatogram(features = 'M70T581',
               sample_ids = 'Human_Plasma_HILP_Ch1_Col1_scIC_062',
               ppm = 5,
               rt_tol = 10,
               highlight_peaks = TRUE) +
  # arrange(group_by = 'sample_id') +
  spectra(rt = 580, mode = "closest", ms_level = 1) +
  labels(title = "Feature M70T581", legend = "Sample") +
  legend(position = "bottom")
```

```{r, fig.height=3}
lcmsPlot(xdata, 'sample_id') +
  chromatogram(features = rbind(c(mz = 70.06507, rt = 580.642449)),
               sample_ids = 'Human_Plasma_HILP_Ch1_Col1_scIC_062',
               ppm = 5,
               rt_tol = 40,
               highlight_peaks = TRUE) +
  spectra(mode = "closest_apex", ms_level = 1) +
  labels(title = "Feature M70T581", legend = "Sample") +
  legend(position = "bottom") +
  layout(design = "C\nS\nS")
```

```{r, fig.height=5, fig.width=3}
lcmsPlot(xdata, 'sample_id') +
  chromatogram(features = rbind(c(mz = 70.06507, rt = 580.642449)),
               sample_ids = 'Human_Plasma_HILP_Ch1_Col1_scIC_062',
               ppm = 5,
               rt_tol = 40,
               highlight_peaks = TRUE) +
  spectra(mode = "across_peak", ms_level = 1) +
  labels(title = "Feature M70T581", legend = "Sample") +
  legend(position = "bottom") +
  layout(design = "C\nS\nS\nS\nS\nS\nS\nS")
```
